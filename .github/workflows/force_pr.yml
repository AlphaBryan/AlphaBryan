name: Protect Prod Branch

on:
  push:
    branches:
      - prod

jobs:
  check-push:
    runs-on: ubuntu-latest

    steps:
      - name: Check if push is from a pull request
        id: check_pr
        run: |
          EVENT=$(jq -r .event_name "$GITHUB_EVENT_PATH")
          if [ "$EVENT" == "push" ]; then
            echo "::set-output name=is_push::true"
          else
            echo "::set-output name=is_push::false"
          fi
        shell: bash

      - name: Refuse push if not from a PR
        if: steps.check_pr.outputs.is_push == 'false'
        run: |
          echo "Error: Push to 'prod' branch is not allowed. Please create a pull request."
          exit 1

      - name: Comment on the commit
        if: steps.check_pr.outputs.is_push == 'false'
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          MESSAGE=":x: Pushing directly to the 'prod' branch is not allowed. Please create a pull request instead."
          echo "::set-output name=commit_sha::$COMMIT_SHA"
          echo "::set-output name=message::$MESSAGE"
